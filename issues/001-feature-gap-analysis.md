# [001] æœ¬å®¶Pydantic AIã¨ã®æ©Ÿèƒ½å·®åˆ†èª¿æŸ»ï¼šå®Ÿè£…ãŒå®¹æ˜“ãªæœªå®Ÿè£…æ©Ÿèƒ½ã®ææ¡ˆ

**Status**: Open
**Priority**: High
**Labels**: `enhancement`, `documentation`, `help wanted`
**Assignee**: (æœªå‰²å½“)
**Related Issues**: (ãªã—)
**GitHub Issue**: (æœªä½œæˆ)
**Created**: 2025-10-30
**Updated**: 2025-10-30

---

## æ¦‚è¦

æœ¬å®¶ã®Pydantic AIã¨ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆpydantic-claude-cliï¼‰ã®æ©Ÿèƒ½å·®åˆ†ã‚’èª¿æŸ»ã—ã€å®Ÿè£…ãŒå®¹æ˜“ãªæœªå®Ÿè£…æ©Ÿèƒ½ã‚’ç‰¹å®šã—ã¾ã—ãŸã€‚

**ç¾åœ¨ã®æ©Ÿèƒ½ã‚«ãƒãƒ¬ãƒƒã‚¸**: ç´„60%
**ç›®æ¨™**: 70-75%ï¼ˆä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§é”æˆå¯èƒ½ï¼‰

---

## å®Ÿè£…ãŒå®¹æ˜“ãªæœªå®Ÿè£…æ©Ÿèƒ½ï¼ˆæ¨å¥¨é †ï¼‰

### 1. ModelSettingsã®å®Œå…¨ã‚µãƒãƒ¼ãƒˆ ğŸŸ¢ å®¹æ˜“åº¦: ä½

**ç¾çŠ¶**: åŸºæœ¬çš„ãªModelSettingsã¯å—ã‘å–ã‚‹ãŒã€`temperature`ã€`max_tokens`ã€`top_p`ç­‰ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒ`ClaudeCodeOptions`ã«æ¸¡ã•ã‚Œã¦ã„ãªã„

**æœ¬å®¶ã®æ©Ÿèƒ½**:
```python
agent = Agent(
    model,
    model_settings={
        'temperature': 0.7,
        'max_tokens': 1000,
        'top_p': 0.9
    }
)
```

**å®Ÿè£…æ–¹é‡**:
- `model.py:239` ã® `request()` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§`model_settings`ã‚’è§£æ
- `ClaudeCodeOptions`ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼ˆClaude Code SDKãŒå¯¾å¿œã—ã¦ã„ã‚‹å ´åˆï¼‰
- å¯¾å¿œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒãƒƒãƒ”ãƒ³ã‚°å‡¦ç†ã‚’è¿½åŠ 

**åˆ©ç‚¹**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¢ãƒ‡ãƒ«ã®æŒ¯ã‚‹èˆã„ã‚’ç´°ã‹ãåˆ¶å¾¡ã§ãã‚‹

**æ¨å®šå·¥æ•°**: 1-2æ™‚é–“

---

### 2. Usageæƒ…å ±ã®è©³ç´°åŒ– ğŸŸ¢ å®¹æ˜“åº¦: ä½

**ç¾çŠ¶**: åŸºæœ¬çš„ãªtoken countã¨costã¯å–å¾—æ¸ˆã¿ã ãŒã€è©³ç´°ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒæœªæ´»ç”¨

**æœ¬å®¶ã®æ©Ÿèƒ½**: ã‚ˆã‚Šè©³ç´°ãªä½¿ç”¨çŠ¶æ³ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°

**å®Ÿè£…æ–¹é‡**:
- `message_converter.py:147` ã® `extract_usage_from_result()` ã‚’æ‹¡å¼µ
- `result_message.usage` ã‹ã‚‰è©³ç´°æƒ…å ±ã‚’æŠ½å‡ºï¼ˆcache hits, thinking tokensç­‰ï¼‰
- `ModelResponse.usage` ã«è¿½åŠ æƒ…å ±ã‚’å«ã‚ã‚‹

**åˆ©ç‚¹**: ãƒ‡ãƒãƒƒã‚°ã‚„ã‚³ã‚¹ãƒˆç®¡ç†ãŒå®¹æ˜“ã«ãªã‚‹

**æ¨å®šå·¥æ•°**: 1æ™‚é–“

---

### 3. Result Validatorã®ã‚µãƒãƒ¼ãƒˆ ğŸŸ¡ å®¹æ˜“åº¦: ä¸­

**ç¾çŠ¶**: æœªå®Ÿè£…

**æœ¬å®¶ã®æ©Ÿèƒ½**:
```python
from pydantic_ai import Agent

agent = Agent(model)

@agent.result_validator
async def validate_response(ctx: RunContext, result: str) -> str:
    if len(result) < 10:
        raise ModelRetry('Response too short')
    return result
```

**å®Ÿè£…æ–¹é‡**:
- Pydantic AIã®Agentå´ãŒæ—¢ã«ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ãŸã‚ã€Modelå´ã¯ç‰¹åˆ¥ãªå¯¾å¿œä¸è¦ã‹ã‚‚
- `ModelRetry`ä¾‹å¤–ã‚’é©åˆ‡ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆå†è©¦è¡Œãƒ­ã‚¸ãƒƒã‚¯ï¼‰
- ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã¦å‹•ä½œç¢ºèª

**åˆ©ç‚¹**: å¿œç­”å“è³ªã®è‡ªå‹•æ¤œè¨¼ã¨å†è©¦è¡Œ

**æ¨å®šå·¥æ•°**: 2-3æ™‚é–“

---

### 4. Model-level Retryè¨­å®š ğŸŸ¡ å®¹æ˜“åº¦: ä¸­

**ç¾çŠ¶**: Pydantic AIã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒªãƒˆãƒ©ã‚¤ã«ä¾å­˜

**æœ¬å®¶ã®æ©Ÿèƒ½**:
```python
agent = Agent(model, retries=3)  # å†è©¦è¡Œå›æ•°ã‚’æ˜ç¤ºçš„ã«è¨­å®š
```

**å®Ÿè£…æ–¹é‡**:
- `ClaudeCodeCLIModel`ã«`retries`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
- `request()` ãƒ¡ã‚½ãƒƒãƒ‰ã§ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
- `ClaudeCLIProcessError`ã®ç¨®é¡ã«å¿œã˜ã¦å†è©¦è¡Œå¯å¦ã‚’åˆ¤å®š

**åˆ©ç‚¹**: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚„ä¸€æ™‚çš„ãªéšœå®³ã¸ã®è€æ€§å‘ä¸Š

**æ¨å®šå·¥æ•°**: 3-4æ™‚é–“

---

### 5. Tool Error Handling ã®æ”¹å–„ ğŸŸ¡ å®¹æ˜“åº¦: ä¸­

**ç¾çŠ¶**: ãƒ„ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ãŒæ±ç”¨çš„ãª`ClaudeCLIProcessError`ã§ãƒ©ãƒƒãƒ—ã•ã‚Œã‚‹

**æœ¬å®¶ã®æ©Ÿèƒ½**: ãƒ„ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ã‚’æ§‹é€ åŒ–ã—ã¦ã€LLMãŒé©åˆ‡ã«å¯¾å¿œã§ãã‚‹

**å®Ÿè£…æ–¹é‡**:
- `tool_converter.py` ã¾ãŸã¯ `mcp_server_fixed.py` ã§ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ
- ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’æ§‹é€ åŒ–ã—ã¦LLMã«è¿”ã™ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ç­‰ï¼‰
- ToolReturnPartã«ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’å«ã‚ã‚‹

**åˆ©ç‚¹**: LLMãŒãƒ„ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ã‹ã‚‰å­¦ç¿’ã—ã€ä¿®æ­£ã‚’è©¦ã¿ã‚‹ã“ã¨ãŒã§ãã‚‹

**æ¨å®šå·¥æ•°**: 3-4æ™‚é–“

---

## å®Ÿè£…ãŒé›£ã—ã„æ©Ÿèƒ½ï¼ˆå‚è€ƒï¼‰

ä»¥ä¸‹ã¯å®Ÿè£…ãŒé›£ã—ãã€çŸ­æœŸçš„ã«ã¯æ¨å¥¨ã—ã¾ã›ã‚“ï¼š

- âŒ **Streaming**: Claude Code SDKã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œãŒä¸æ˜ã€å¤§ããªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å¤‰æ›´ãŒå¿…è¦
- âŒ **Multimodal (ç”»åƒãƒ»ãƒ•ã‚¡ã‚¤ãƒ«)**: CLIçµŒç”±ã§ã®ç”»åƒå‡¦ç†ãŒæœªå¯¾å¿œ
- âŒ **Output tools / Structured output**: æ§‹é€ åŒ–å‡ºåŠ›ã®å‡¦ç†ãŒè¤‡é›‘
- âŒ **Full RunContext support**: `ctx.retry()`, `ctx.run_step()` ç­‰ã®CLIå´ã®åˆ¶ç´„

---

## æ¨å¥¨å®Ÿè£…é †åº

1. **ModelSettingså®Œå…¨ã‚µãƒãƒ¼ãƒˆ** (1-2æ™‚é–“) - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Šã€å®Ÿè£…ç°¡å˜
2. **Usageæƒ…å ±è©³ç´°åŒ–** (1æ™‚é–“) - ãƒ‡ãƒãƒƒã‚°ãƒ»é‹ç”¨æ”¹å–„
3. **Result Validator** (2-3æ™‚é–“) - å“è³ªå‘ä¸Šã€æ—¢å­˜æ©Ÿèƒ½ã¨ã®çµ±åˆç¢ºèªãŒå¿…è¦
4. **Retryè¨­å®š** (3-4æ™‚é–“) - ä¿¡é ¼æ€§å‘ä¸Š

---

## è£œè¶³æƒ…å ±

### ç¾åœ¨ã®å®Ÿè£…çŠ¶æ³ã¾ã¨ã‚

**å®Ÿè£…æ¸ˆã¿ï¼ˆâœ…ï¼‰**:
- ãƒ†ã‚­ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ã®ä¼šè©±
- ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
- ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ï¼ˆ@agent.tool_plainï¼‰
- çµ„ã¿è¾¼ã¿ãƒ„ãƒ¼ãƒ«åˆ¶å¾¡ï¼ˆToolPresetï¼‰
- å®Ÿé¨“çš„ä¾å­˜æ€§ã‚µãƒãƒ¼ãƒˆï¼ˆã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºå¯èƒ½ãªå‹ã®ã¿ï¼‰

**æœªå®Ÿè£…ï¼ˆâŒï¼‰**:
- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¿œç­”
- ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç”»åƒãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
- Output tools
- å®Œå…¨ãªRunContextã‚µãƒãƒ¼ãƒˆ
- Result validators
- Model-level retryè¨­å®š

### å‚è€ƒãƒªãƒ³ã‚¯

- [Pydantic AIå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://ai.pydantic.dev/)
- [Pydantic AI - Result Validators](https://ai.pydantic.dev/api/result/)
- [Pydantic AI - HTTP Request Retries](https://ai.pydantic.dev/retries/)

---

## ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ 

ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã‚’å€‹åˆ¥ã®issueã«åˆ†å‰²ã—ã€å®Ÿè£…ã‚’é€²ã‚ã‚‹ã“ã¨ã‚’ææ¡ˆã—ã¾ã™ã€‚å„æ©Ÿèƒ½ã«ã¤ã„ã¦ï¼š

- [ ] ModelSettingsã®å®Œå…¨ã‚µãƒãƒ¼ãƒˆ
- [ ] Usageæƒ…å ±ã®è©³ç´°åŒ–
- [ ] Result Validatorã®ã‚µãƒãƒ¼ãƒˆ
- [ ] Model-level Retryè¨­å®š
- [ ] Tool Error Handlingã®æ”¹å–„
